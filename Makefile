# Коренева ціль. Запускає повне налаштування: встановлення залежностей,
# генерацію ключа та повний рефреш бази даних.
setup: install db-refresh clear

# ----------------------------------------------------------------------
# 1. ОСНОВНЕ НАЛАШТУВАННЯ (залежності та .env)
# ----------------------------------------------------------------------
install:
	@echo "--- 1. Встановлення PHP-залежностей..."
	composer install --no-interaction
	@echo "--- 2. Налаштування файлу середовища (.env)..."
	-cp .env.example .env
	@echo "--- 3. Генерація ключа додатку..."
	php artisan key:generate

# ----------------------------------------------------------------------
# 2. УПРАВЛІННЯ БАЗОЮ ДАНИХ
# ----------------------------------------------------------------------
db-refresh:
	@echo "--- 4. Повний рефреш бази даних (ВИДАЛИТИ ВСІ ДАНІ)..."
	# Використовуємо php artisan замість sail artisan, оскільки ми вже всередині контейнера.
	php artisan migrate:fresh --seed

# ----------------------------------------------------------------------
# 3. ОЧИЩЕННЯ КЕШУ
# ----------------------------------------------------------------------
clear:
	@echo "--- 5. Очищення кешів Laravel..."
	php artisan optimize:clear
	php artisan view:clear
	php artisan config:clear
	php artisan route:clear

# ----------------------------------------------------------------------
# УТИЛІТИ
# ----------------------------------------------------------------------
test:
	@echo "--- Запуск тестів PHPUnit..."
	php artisan test


#4. ПЕРЕВІРКА ЯКОСТІ КОДУ (Лінтери)
#----------------------------------------------------------------------

lint:
	@echo "--- 6. Запуск статичного аналізу (PHPStan)..."
# Запускаємо без параметрів, оскільки конфігурація вказана у phpstan.neon
	./vendor/bin/phpstan analyse
	@echo "--- 7. Запуск перевірки стандартів кодування (PHPCS) на app та src..."
# Використовуємо стандарт PSR12. Оновіть шляхи та стандарт, якщо потрібно.
	./vendor/bin/phpcs --standard=PSR12 app tests

fix:
	@echo "--- 8. Автоматичне виправлення стандартів кодування (PHPCBF)..."
# Автоматично виправляє стильові порушення (використовуйте обережно, бажано на git-гілці)
	./vendor/bin/phpcbf --standard=PSR12 app tests
#----------------------------------------------------------------------

# Запобігає проблемам розширення оболонки (Shell Expansion)
.PHONY: setup install db-refresh clear test
